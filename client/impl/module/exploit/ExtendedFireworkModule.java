package net.shoreline.client.impl.module.exploit;

import it.unimi.dsi.fastutil.ints.IntListIterator;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import net.minecraft.class_1671;
import net.minecraft.class_2596;
import net.minecraft.class_2708;
import net.minecraft.class_2716;
import net.minecraft.class_6374;
import net.shoreline.client.api.event.listener.EventListener;
import net.shoreline.client.api.module.ModuleCategory;
import net.shoreline.client.api.module.ToggleModule;
import net.shoreline.client.impl.event.TickEvent;
import net.shoreline.client.impl.event.entity.projectile.RemoveFireworkEvent;
import net.shoreline.client.impl.event.network.PacketEvent;
import net.shoreline.client.init.Managers;
import net.shoreline.client.mixin.accessor.AccessorFireworkRocketEntity;
import net.shoreline.client.util.math.timer.CacheTimer;
import net.shoreline.client.util.math.timer.Timer;

public class ExtendedFireworkModule extends ToggleModule {
   private final List<class_6374> packetList = new ArrayList();
   private boolean extendFirework;
   private final Timer extendFireworkTimer = new CacheTimer();
   private class_1671 firework;

   public ExtendedFireworkModule() {
      super("ExtendedFirework", "Extends firework boost duration", ModuleCategory.EXPLOITS);
   }

   public void onDisable() {
      if (this.firework != null) {
         ((AccessorFireworkRocketEntity)this.firework).hookExplodeAndRemove();
      }

      this.firework = null;
      this.extendFirework = false;
      Iterator var1 = this.packetList.iterator();

      while(var1.hasNext()) {
         class_6374 packet = (class_6374)var1.next();
         Managers.NETWORK.sendPacket(packet);
      }

      this.packetList.clear();
   }

   @EventListener
   public void onRemoveFirework(RemoveFireworkEvent event) {
      if (mc.field_1724 != null) {
         if (mc.field_1724.method_6128() && this.firework != event.getRocketEntity() && ((AccessorFireworkRocketEntity)event.getRocketEntity()).hookWasShotByEntity() && ((AccessorFireworkRocketEntity)event.getRocketEntity()).getShooter() == mc.field_1724) {
            this.extendFirework = true;
            event.cancel();
            this.firework = event.getRocketEntity();
            this.extendFireworkTimer.reset();
         }

      }
   }

   @EventListener
   public void onTick(TickEvent event) {
      if (this.extendFirework) {
         if (!mc.field_1724.method_6128() || mc.field_1724.method_24828() || this.extendFireworkTimer.passed(50000)) {
            this.extendFirework = false;
            if (this.firework != null) {
               ((AccessorFireworkRocketEntity)this.firework).hookExplodeAndRemove();
               this.firework = null;
            }

            Iterator var2 = this.packetList.iterator();

            while(var2.hasNext()) {
               class_6374 packet = (class_6374)var2.next();
               Managers.NETWORK.sendPacket(packet);
            }

            this.packetList.clear();
         }

      }
   }

   @EventListener
   public void onPacketOutbound(PacketEvent.Outbound event) {
      if (mc.field_1724 != null && mc.field_1687 != null) {
         class_2596 var3 = event.getPacket();
         if (var3 instanceof class_6374) {
            class_6374 packet = (class_6374)var3;
            if (this.extendFirework && mc.field_1724.method_6128()) {
               event.cancel();
               this.packetList.add(packet);
            }
         }

      }
   }

   @EventListener
   public void onPacketInbound(PacketEvent.Inbound event) {
      if (mc.field_1724 != null && mc.field_1687 != null && mc.field_1724.method_6128() && this.extendFirework) {
         class_2596 var3 = event.getPacket();
         if (var3 instanceof class_2716) {
            class_2716 packet = (class_2716)var3;
            if (this.firework != null) {
               IntListIterator var6 = packet.method_36548().iterator();

               while(var6.hasNext()) {
                  int id = (Integer)var6.next();
                  if (id == this.firework.method_5628()) {
                     event.cancel();
                     return;
                  }
               }
            }
         }

         var3 = event.getPacket();
         if (var3 instanceof class_2708) {
            class_2708 packet = (class_2708)var3;
            this.extendFirework = false;
            if (this.firework != null) {
               ((AccessorFireworkRocketEntity)this.firework).hookExplodeAndRemove();
               this.firework = null;
            }

            Iterator var7 = this.packetList.iterator();

            while(var7.hasNext()) {
               class_6374 p = (class_6374)var7.next();
               Managers.NETWORK.sendPacket(p);
            }

            this.packetList.clear();
         }

      }
   }

   public boolean isExtendingFirework() {
      return this.extendFirework;
   }
}

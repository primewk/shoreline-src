package net.shoreline.client.impl.module.exploit;

import net.minecraft.class_2596;
import net.minecraft.class_2639;
import net.minecraft.class_2805;
import net.shoreline.client.api.event.listener.EventListener;
import net.shoreline.client.api.module.ModuleCategory;
import net.shoreline.client.api.module.ToggleModule;
import net.shoreline.client.impl.event.TickEvent;
import net.shoreline.client.impl.event.network.DisconnectEvent;
import net.shoreline.client.impl.event.network.PacketEvent;
import net.shoreline.client.init.Managers;
import net.shoreline.client.util.math.timer.CacheTimer;
import net.shoreline.client.util.math.timer.Timer;

public class FastLatencyModule extends ToggleModule {
   private long requestTime;
   private long latency;
   private final Timer lastRequest = new CacheTimer();
   private final Timer requestTimer = new CacheTimer();

   public FastLatencyModule() {
      super("FastLatency", "Calculates server ping", ModuleCategory.EXPLOITS);
   }

   public String getModuleData() {
      return String.format("%dms", this.latency);
   }

   @EventListener
   public void onDisconnect(DisconnectEvent event) {
      this.latency = 0L;
      this.requestTime = 0L;
   }

   @EventListener
   public void onTick(TickEvent event) {
      if (this.lastRequest.passed(5000) && this.requestTimer.passed(500)) {
         Managers.NETWORK.sendPacket(new class_2805(1000, "w "));
         this.requestTimer.reset();
         this.lastRequest.reset();
         this.requestTime = System.currentTimeMillis();
      }

   }

   @EventListener
   public void onPacketInbound(PacketEvent.Inbound event) {
      class_2596 var3 = event.getPacket();
      if (var3 instanceof class_2639) {
         class_2639 packet = (class_2639)var3;
         if (packet.method_11399() == 1000) {
            this.latency = System.currentTimeMillis() - this.requestTime;
            this.lastRequest.setElapsedTime(-255L);
         }
      }

   }

   public long getLatency() {
      return this.latency;
   }
}
